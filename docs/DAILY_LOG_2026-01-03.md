# 📅 2026-01-03

---

### 🧑‍💻 오늘 수행한 작업 요약

디지몬 타마고치 게임의 수면 시스템 UI/UX 개선 및 실시간 상태 표시 기능 구현. 수면 방해 알림, 수면 시간 정보 표시, 수면 중 타이머 동작 최적화를 완료했습니다.

---

### 🔧 상세 작업 내용

#### 1. 수면 방해 알림 시스템 구현
- **배경**: 수면 중 디지몬을 깨웠을 때 사용자에게 즉시 피드백 제공 필요
- **구현**:
  - `wakeForInteraction` 함수에 `onSleepDisturbance` 콜백 추가
  - `GameScreen`에 토스트 알림 컴포넌트 추가 (3초 자동 사라짐)
  - 상태 배지에 "수면 방해! (X분 Y초 남음) 😴" 실시간 표시
- **결과**: 수면 방해 발생 시 즉시 알림으로 사용자 인지도 향상

#### 2. 수면 시간 정보 표시 기능 추가
- **배경**: 사용자가 수면 시간과 남은 시간을 쉽게 확인할 수 있도록 개선
- **구현**:
  - `sleepUtils.js` 유틸리티 함수 생성 (`getTimeUntilSleep`, `getTimeUntilWake`, `formatSleepSchedule`)
  - `DigimonStatusBadges`에 "수면까지 X시간 Y분 후 😴" 배지 추가
  - `StatsPopup`에 "4. 수면 정보" 섹션 신규 추가
    - 수면 시간, 수면 상태, 수면까지/기상까지 남은 시간
    - 수면 방해 중 깨어있는 시간, 수면 방해 횟수
- **결과**: 수면 관련 정보를 한눈에 확인 가능한 UI 제공

#### 3. 수면 중 불 켜짐 시간 카운트다운 표시
- **배경**: 수면 시간에 불이 켜져 있으면 30분 후 케어 미스 발생, 사용자에게 경고 필요
- **구현**:
  - `DigimonStatusBadges`에 "피곤함 😫 (불 끄기까지 X분 Y초)" 배지 추가
  - `StatsPopup`에 "불 끄기까지: X분 Y초 남음 (30분 초과 시 케어 미스)" 표시
  - 불을 꺼면 "불 꺼짐 ✓ (잠자는 중)" 메시지 표시
  - 조건 고도화: `sleepStatus === 'TIRED' && isLightsOn && sleepLightOnStart`일 때만 표시
- **결과**: 케어 미스 예방을 위한 실시간 경고 시스템 구축

#### 4. 수면 중 타이머 감소 방지 로직 구현
- **배경**: 매뉴얼에 따르면 수면 중에는 배고픔/힘/똥 타이머가 감소하지 않아야 함
- **구현**:
  - `handleHungerTick`, `handleStrengthTick` 함수에 `isSleeping` 파라미터 추가
  - `updateLifespan` 함수에 `isSleeping` 파라미터 추가 (poopCountdown 감소 방지)
  - `Game.jsx`에서 수면 상태를 먼저 확인한 후 타이머 감소 로직에 전달
- **결과**: 수면 중 타이머가 정지하여 게임 밸런스 개선

#### 5. 실시간 업데이트 시스템 구현
- **배경**: 수면 방해 시간, 불 켜짐 시간을 초 단위로 실시간 표시 필요
- **구현**:
  - `DigimonStatusBadges`, `StatsPopup`에 `useState`와 `useEffect`로 1초마다 현재 시간 업데이트
  - 모든 시간 표시를 초 단위까지 실시간 갱신
- **결과**: 사용자가 정확한 남은 시간을 실시간으로 확인 가능

#### 6. StatsPopup 시간 포맷 개선
- **배경**: "Lifespan: 0 day 658 min 56 sec" 형식이 가독성 낮음
- **구현**:
  - `formatTime` 함수 개선: "0 day 10 hour 58 min 56 sec" 형식으로 변경
  - `formatTimeToEvolve` 함수도 동일한 형식으로 통일
- **결과**: 시간 정보 가독성 향상

#### 7. 버그 수정
- **문제 1**: `StatsPopup.jsx`에서 `sleepSchedule` 중복 선언 오류
  - **해결**: props로 받은 `sleepSchedule`을 `currentSleepSchedule`로 변경하여 중복 해결
- **문제 2**: `Game.jsx`에서 `updatedStats` 초기화 전 접근 오류
  - **해결**: 변수 선언 순서 변경 (수면 상태 확인 → `updatedStats` 선언 → `sleepDisturbances` 설정)

---

### 🚧 문제 & 해결 과정

#### 문제 1: 수면 중 타이머가 계속 감소하는 현상
- **원인**: `handleHungerTick`, `handleStrengthTick`, `updateLifespan` 함수에 수면 상태 체크 로직 없음
- **해결**: 각 함수에 `isSleeping` 파라미터 추가 및 수면 중일 때 early return 처리
- **효과**: 수면 중 타이머 정지로 게임 밸런스 정확도 향상

#### 문제 2: 불을 꺼도 카운트다운이 계속 표시되는 현상
- **원인**: `sleepLightOnStart`가 null로 설정되기 전까지 조건 체크가 완료되지 않음
- **해결**: 표시 조건을 `sleepStatus === 'TIRED' && isLightsOn && sleepLightOnStart`로 고도화
- **효과**: 불을 꺼면 즉시 카운트다운 사라지고 "불 꺼짐" 메시지 표시

#### 문제 3: 실시간 업데이트로 인한 성능 이슈 가능성
- **고민**: 1초마다 상태 업데이트가 성능에 영향을 줄 수 있음
- **해결**: `useEffect`의 cleanup 함수로 타이머 정리, 컴포넌트 언마운트 시 메모리 누수 방지
- **효과**: 안정적인 실시간 업데이트 구현

---

### 📁 기술 스택 / 라이브러리

- **React Hooks**: `useState`, `useEffect` (실시간 업데이트)
- **Firebase/Firestore**: 기존 아키텍처 유지 (Lazy Update 로직)
- **JavaScript**: 유틸리티 함수 구현 (`sleepUtils.js`)

---

### 📈 결과 / 성과

#### 사용자 경험 개선
- ✅ 수면 방해 발생 시 즉시 알림 (토스트 + 상태 배지)
- ✅ 수면 시간 정보를 한눈에 확인 가능 (StatsPopup 신규 섹션)
- ✅ 케어 미스 예방을 위한 실시간 경고 시스템 구축
- ✅ 시간 정보 가독성 향상 (일/시간/분/초 형식)

#### 게임 밸런스 개선
- ✅ 수면 중 타이머 정지로 매뉴얼 준수
- ✅ 수면 시스템의 정확도 향상

#### 코드 품질 개선
- ✅ 유틸리티 함수 분리로 재사용성 향상 (`sleepUtils.js`)
- ✅ 실시간 업데이트 로직 최적화 (메모리 누수 방지)
- ✅ 버그 수정으로 안정성 향상

---

### 🧠 배운 점

1. **실시간 업데이트 최적화**: 1초마다 상태 업데이트 시 `useEffect` cleanup 함수로 메모리 누수 방지가 중요함을 확인
2. **조건부 렌더링 최적화**: 복잡한 조건을 명확하게 분리하여 가독성과 유지보수성 향상
3. **사용자 피드백의 중요성**: 수면 방해, 케어 미스 경고 등 즉시 피드백 제공이 사용자 경험에 큰 영향을 미침
4. **게임 밸런스 구현**: 매뉴얼에 명시된 규칙(수면 중 타이머 정지)을 정확히 구현하는 것이 게임의 공정성에 중요

---

### 🔜 다음 작업 예정

1. **수면 시스템 추가 개선**
   - 수면 방해 횟수에 따른 진화 조건 영향 분석
   - 수면 호출(Call) 기능 UI 개선

2. **성능 최적화**
   - 실시간 업데이트 컴포넌트의 렌더링 최적화 검토
   - 불필요한 리렌더링 방지 (React.memo, useMemo 활용)

3. **테스트 및 검증**
   - 수면 중 타이머 정지 기능 테스트
   - 다양한 수면 스케줄 시나리오 테스트

4. **문서화**
   - 수면 시스템 동작 방식 문서화
   - 사용자 가이드에 수면 관련 팁 추가

---

