# 활동 로그: 수면·케어 구분 분석

## 사용자 기대

- **수면**: 몇 시에 잠듦, 깨어남, 수면 방해, 불 켜짐/꺼짐 등 수면 관련 로그
- **케어**: 케어미스테이크(케어 미스)만

## 현재 코드에서의 기록 방식

### 로그 타입 정리

| type | 용도 | 예시 텍스트 |
|------|------|-------------|
| **CARE_MISTAKE** | 수면 방해, 호출/수면 케어미스 | `수면 방해(사유: 교감 - 다이어트): 10분 동안 깨어있음`, `케어미스(사유: 배고픔 콜 10분 무시): n → n+1`, `케어미스(사유: 수면 콜 10분 무시): n → n+1` |
| **CAREMISTAKE** | 의도적 케어미스, 피곤 방치 | `케어미스(사유: 괜히 괴롭히기): n → n+1`, `케어미스(사유: 수면 시간에 불 켜둔 채 30분 경과 - 피곤 방치)` |
| **ACTION** | 불 켜짐/꺼짐, 야행성 등 | `Lights: ON`, `Lights: OFF` |

### 수면 관련으로 남는 로그 (현재)

- **수면 방해**: `CARE_MISTAKE` + 텍스트에 "수면 방해" (교감/먹이/훈련/배틀/청소 등으로 깨움 → 10분 깨어있음)
- **수면 케어미스**: `CARE_MISTAKE` + "수면 케어미스 발생" (수면 호출 타임아웃 등)
- **불 켜짐/꺼짐**: `ACTION` + "Lights: ON" / "Lights: OFF" (useGameHandlers.handleToggleLights)
- **잠듦/깨어남**: **현재 별도 로그 없음** (수면 상태는 1초 타이머에서 계산만 하고, “몇 시에 잠들었다/깼다” 로그는 남기지 않음)

### 케어미스로 남는 로그 (현재)

- **CARE_MISTAKE**: 배고픔 케어미스, 힘 케어미스, 수면 케어미스 (텍스트에 "케어미스" 또는 "Care Mistake" 포함)
- **CAREMISTAKE**: 괴롭히기(의도적 케어미스), "Tired for too long"(수면 시간에 피곤하게 방치)

## 결론: "수면·케어" 한 탭이 맞는가?

**아니요.** 타입만 보면 `CARE_MISTAKE`/`CAREMISTAKE`에 수면 이벤트와 케어미스가 섞여 있어서:

- **수면**에는: 수면 방해, 수면 케어미스, 불 켜짐/꺼짐만 보여주는 편이 맞고  
- **케어**에는: 케어미스만(배고픔/힘/수면 케어미스 + 괴롭히기, Tired 등) 보여주는 편이 맞습니다.

따라서 탭을 **수면** / **케어** 두 개로 나누고, **텍스트 기준**으로 구분하는 것이 맞습니다.

- **수면 탭**:  
  - `CARE_MISTAKE` 이면서 텍스트에 "수면 방해" 또는 "수면 케어미스" 포함  
  - `ACTION` 이면서 텍스트에 "Lights" 포함 (불 켜짐/꺼짐)
- **케어 탭**:  
  - `CARE_MISTAKE` 이면서 텍스트에 "케어미스" 또는 "Care Mistake" 포함  
  - `CAREMISTAKE` 전부

(같은 로그가 “수면 케어미스”처럼 수면이면서 케어미스인 경우, 수면 탭과 케어 탭 둘 다에 나와도 됨. 현재 구현에서는 수면 탭은 “수면” 키워드, 케어 탭은 “케어미스/Care Mistake” 키워드로 필터하므로 수면 케어미스는 두 탭 모두에 표시됨.)

## 잠듦/깨어남 로그 (구현 완료)

- **SLEEP_START**: 수면 구간 진입 시 1초 타이머에서 `잠들음 (HH:MM)` 형태로 기록 (Game.jsx, prevSleepingRef로 이전 수면 상태와 비교).
- **SLEEP_END**: 수면 구간 이탈 시 `깨어남 (HH:MM)` 형태로 기록.
- 활동 기록 모달의 **수면** 탭에 `SLEEP_START` / `SLEEP_END` 타입이 포함되어 표시됨.

---

## 1초 타이머란? (DB와의 관계)

### 1초 타이머가 하는 일

- **위치**: `Game.jsx`의 `useEffect` 안에서 `setInterval(..., 1000)`으로 **브라우저(클라이언트)에서만** 1초마다 도는 코드입니다.
- **역할**: 화면에 보이는 숫자/상태를 **실시간으로** 갱신하기 위함입니다.
  - 예: 수명(lifespan), 진화까지 남은 시간, 배변 개수, 배고픔/힘, **수면 여부**(잠자고 있는지 깨어 있는지) 등.
- **동작 방식**: 매 1초마다 “이전 상태 + 경과 시간”을 이용해 **메모리(React state)** 만 바꿉니다.  
  → `setDigimonStats(...)` 로 **DB에 쓰지 않고** 화면만 다시 그립니다.

### DB에는 언제 쓰나요?

- **1초마다 DB에 쓰거나 조회하지 않습니다.**
- 프로젝트 규칙(Lazy Update)에 따라, **사용자 액션**이 있을 때만 저장합니다.
  - 먹이 주기, 훈련, 배틀, 청소, 치료, 조명 토글, 사망 처리 등 → 그때 `setDigimonStatsAndSave` / `saveStats` 호출로 Firestore에 씁니다.
- **SLEEP_START / SLEEP_END**도 마찬가지입니다.
  - 1초 타이머가 **매 초** DB에 쓰는 게 아니라,
  - “이전 틱은 깨어 있었는데 이번 틱은 잠듦” / “이전 틱은 잠자고 있었는데 이번 틱은 깸”처럼 **상태가 바뀐 순간에만** `addActivityLog` + `appendLogToSubcollection`을 호출합니다.
  - 그래서 하루에 보통 **잠들 때 1번, 깰 때 1번** 정도만 로그가 추가되고, 그때만 DB(logs 서브컬렉션)에 쓰입니다.

### 정리

| 구분 | 1초 타이머 | DB(Firestore) |
|------|------------|----------------|
| **실행 주기** | 브라우저에서 1초마다 | 사용자 액션 시 + 수면 전환 시 등 **이벤트 시**만 |
| **매 1초** | 메모리(React state)만 갱신, UI 갱신 | ❌ 쓰기/조회 없음 |
| **수면 로그** | 매 초 “지금 잠자는지”만 계산 | 잠듦/깨어남 **전환 시에만** 로그 1건 추가 후 `appendLogToSubcollection` 호출 |
